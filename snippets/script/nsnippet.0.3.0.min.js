/*! nativescript-snippets-web - v0.3.0 - 2016-04-06 */var nsnippetData=function(){var a="25kywmusr7n17xok",b=new Everlive(a),c=b.data("Snippets");return{getSnippet:function(a,b){var d=$.Deferred(),e=new Everlive.Query;return console.log("Version",b,a),""===b?(console.log("Get latest version",a),e.where().eq("SnippetUid",a).done().orderDesc("SequenceNumber").take(1)):e.where().eq("SnippetUid",a).eq("SequenceNumber",parseInt(b)).done().take(1),c.get(e).then(function(a){console.log("Get Success",a),d.resolve(a)},function(a){console.warn("Get Error",a),d.reject(a)}),d},getSnippetMultiple:function(a){var b=$.Deferred(),d=new Everlive.Query;return console.log("Multiple UID",a),d.where().isin("SnippetUid",a).done().orderDesc("SequenceNumber").select("SnippetXML","SnippetCSS","SnippetJS","Title","Description","SnippetUid","SequenceNumber"),c.withHeaders({"X-Everlive-Custom-Paramters":{MultiQuery:1}}).get(d).then(function(a){console.log("Get Multiple Success",a),b.resolve(a)},function(a){console.warn("Get Multiple Error",a),b.reject(a)}),b},saveSnippet:function(a,b,d,e,f,g){var h=$.Deferred();return c.create({SnippetXML:a,SnippetCSS:b,SnippetJS:d,Title:e,Description:f,SnippetUid:g}).then(function(a){console.log("Save Success",a,g),h.resolve(a.result.RevNo,a.result.Id)},function(a){console.warn("Save Error",a),h.reject(a)}),h},updateSnippet:function(a,b,d,e,f,g){var h=$.Deferred();return c.update({SnippetXML:a,SnippetCSS:b,SnippetJS:d,Title:e,Description:f},{Id:g}).then(function(a){console.log("Update Success",a),h.resolve(a)},function(a){console.warn("Update Error",a),h.reject(a)}),h}}}(),delay=function(){var a=0;return function(b,c){clearTimeout(a),a=setTimeout(b,c)}}();window.nsnippet=function(a,b,c){var d,e,f,g=($("#errMsg"),$("#editorXml")),h=($("#editorCss"),$("#editorJs"),$("#txtTitle")),i=$("#txtDesc"),j=document.getElementById("content"),k=$("#qrCode"),l=$("#QRbox"),m=$("#innerQRbox"),n=$("#appHeader"),o=$(".loadBar > div"),p=$(".loadBar"),q=$("#btnShare"),r=$("#btnSaveRevision"),s=kendo.observable({saving:!1}),t={browserVersion:function(){var a,b=navigator.userAgent,c=b.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(c[1])?(a=/\brv[ :]+(\d+)/g.exec(b)||[],{name:"IE",version:a[1]||""}):"Chrome"===c[1]&&(a=b.match(/\bOPR\/(\d+)/),null!==a)?{name:"Opera",version:a[1]}:(c=c[2]?[c[1],c[2]]:[navigator.appName,navigator.appVersion,"-?"],null!==(a=b.match(/version\/(\d+)/i))&&c.splice(1,1,a[1]),{name:c[0],version:c[1]})},loadSavedWip:function(){if(a.localStorage||"/"!==window.location.pathname){var b=localStorage.getItem("wip.xml"),c=localStorage.getItem("wip.css"),g=localStorage.getItem("wip.js");wipTitle=localStorage.getItem("wip.title"),wipDesc=localStorage.getItem("wip.desc"),void 0!==b&&d.setValue(b),void 0!==c&&e.setValue(c),void 0!==g&&f.setValue(g),void 0!==wipTitle&&h.val(wipTitle),void 0!==wipDesc&&i.val(wipDesc)}},generateUID:function(){return("000000"+(Math.random()*Math.pow(36,6)<<0).toString(36)).substr(-6)},setUrl:function(){c.log(window.location);var a=window.location.pathname;if("/"===a){var b=t.generateUID();history.replaceState({},"Title",b+"/")}else t.loadSnippet(a);t.updateQrCode()},loadSnippet:function(a){b.getSnippet(a.substr(1,6),a.substr(8)).done(function(b){var g=b.result[0].SequenceNumber||1;c.log("PATH DEBUG",a,a.substr(7,1)),"/"!==a.substr(7,1)&&(g=a.substr(1,6)+"/"+g),history.replaceState({},"Title",g),d.setValue(b.result[0].SnippetXML),e.setValue(b.result[0].SnippetCSS),f.setValue(b.result[0].SnippetJS),h.val(b.result[0].Title),i.val(b.result[0].Description);var j={XML:b.result[0].SnippetXML,CSS:b.result[0].SnippetCSS,JS:b.result[0].SnippetJS,Title:b.result[0].Title,Desc:b.result[0].Description};sessionStorage.setItem("serverState",JSON.stringify(j))}).fail(function(a){c.warn("Error Loading Snippet",a)})},saveSnippet:function(d,e,f,g,h,i){var j,k=window.location.pathname,l=k.substr(1,6),m=JSON.parse(sessionStorage.getItem("snippetRev"));s.set("saving",!0),o.fadeIn("fast"),o.width("20%"),null!==m&&""!==m&&(m.slug===l?j=m.revId:sessionStorage.setItem("snippetRev","")),o.width("40%"),void 0===j||i?(c.log("Create New Revision"),b.saveSnippet(d,e,f,g,h,l).done(function(b,c){o.width("60%");var d=b||1;history.pushState({},"Title",d),t.updateQrCode(),sessionStorage.setItem("snippetRev",JSON.stringify({revId:c,slug:l})),a.localstorage&&(localStorage.setItem("wip.xml",""),localStorage.setItem("wip.css",""),localStorage.setItem("wip.js",""),localStorage.setItem("wip.title",""),localStorage.setItem("wip.desc","")),o.width("80%"),p.attr("title","New revision saved at "+new Date),p.removeClass("error"),p.kendoTooltip({width:300,position:"top"})}).fail(function(a){c.warn("Error Saving Snippet",a),p.attr("title","Error saving progress to server."),p.addClass("error")}).always(function(){s.set("saving",!1),o.width("100%"),o.fadeOut("slow",function(){o.width("5%")})})):(c.log("Update Revision",j),b.updateSnippet(d,e,f,g,h,j).done(function(b){a.localstorage&&(localStorage.setItem("wip.xml",""),localStorage.setItem("wip.css",""),localStorage.setItem("wip.js",""),localStorage.setItem("wip.title",""),localStorage.setItem("wip.desc","")),o.width("60%"),p.attr("title","Autosaved at "+new Date),p.removeClass("error"),p.kendoTooltip({width:300,position:"bottom"})}).fail(function(a){c.warn("Error Updating Snippet",a),p.attr("title","Error saving progress to server."),p.addClass("error")}).always(function(){s.set("saving",!1),o.width("100%"),o.fadeOut("slow",function(){o.width("5%")})}))},updateQrCode:function(){k.kendoQRCode({value:window.location.origin+window.location.pathname,errorCorrection:"M",size:155,border:{color:"#000000",width:2}})},killOldBrowsers:function(){var a=t.browserVersion();return"Firefox"===a.name&&parseInt(a.version)<4?void c.warn("Browser version not supported :("):void 0}};return{init:function(){t.setUrl();var b="    ___   ___     ____        _                  _        \n   / / \\ | \\ \\   / ___| _ __ (_)_ __  _ __   ___| |_ ___  \n  | ||  \\| || |  \\___ \\| '_ \\| | '_ \\| '_ \\ / _ \\ __/ __| \n < < | |\\  | > >  ___) | | | | | |_) | |_) |  __/ |_\\__ \\ \n  | ||_| \\_|| |  |____/|_| |_|_| .__/| .__/ \\___|\\__|___/ \n  \\_\\     /_/                 |_|   |_|                     ";c.log("%c"+b,"color:blue;background:#EEE;"),c.log("BROWSER",t.browserVersion()),d=CodeMirror.fromTextArea(document.getElementById("editorXml"),{mode:"application/xml",lineNumbers:!0,matchBrackets:!0,autoCloseBrackets:!0,matchTags:!0}),e=CodeMirror.fromTextArea(document.getElementById("editorCss"),{mode:"text/css",lineNumbers:!0,matchBrackets:!0}),f=CodeMirror.fromTextArea(document.getElementById("editorJs"),{mode:"text/javascript",lineNumbers:!0,matchBrackets:!0,autoCloseBrackets:!0}),nsnippet.resizeEditor(),j.style.opacity="1",a.flexbox&&"/"===window.location.pathname&&t.loadSavedWip(),$(window).on("resize",nsnippet.resizeEditor),n.on("click","h1, #QRbox",function(){l.hasClass("open")?(l.removeClass("open"),l.animate({height:"10px"},1e3,"easeOutExpo",function(){m.hide()})):(m.show(),l.addClass("open"),l.animate({height:"225px"},1e3,"easeOutBounce",void 0))}),r.on("click",nsnippet.saveVersion),q.on("click",function(){var a=window.location.href,b="{N} Snippets | Check-out my {N} Snippet: "+a;window.open("https://twitter.com/share?url="+a+"&text="+b+"&","twitterwindow","null, null, null, null, toolbar=0, location=0, menubar=0, directories=0, scrollbars=0")}),$("#txtDesc, #txtTitle").on("change",function(){delay(nsnippet.update,800)}),d.on("change",function(){delay(nsnippet.update,800)}),e.on("change",function(){delay(nsnippet.update,800)}),f.on("change",function(){delay(nsnippet.update,800)})},resizeEditor:function(){var a=g.parent().height(),b=g.parent().width();d.setSize(b,a),e.setSize(b,a),f.setSize(b,a)},update:function(b){var c=d.getValue(),g=e.getValue(),j=f.getValue(),k=h.val(),l=i.val();a.localstorage&&(localStorage.setItem("wip.xml",c),localStorage.setItem("wip.css",g),localStorage.setItem("wip.js",j),localStorage.setItem("wip.title",k),localStorage.setItem("wip.desc",l));var m={XML:c,CSS:g,JS:j,Title:k,Desc:l},n=JSON.stringify(m);n!==sessionStorage.getItem("serverState")&&b!==!1&&t.saveSnippet(c,g,j,k,l)},saveVersion:function(){var a=d.getValue(),b=e.getValue(),c=f.getValue(),g=h.val(),j=i.val();t.saveSnippet(a,b,c,g,j,!0)}}}(Modernizr,nsnippetData,console);